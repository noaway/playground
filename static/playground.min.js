function HTTPTransport(e){"use strict";function t(e,t){function n(){if(t&&0!==t.length){var o=t.shift();if(0===o.Delay)return e({Kind:o.Kind,Body:o.Message}),void n();r=setTimeout(function(){e({Kind:o.Kind,Body:o.Message}),n()},o.Delay/1e6)}else e({Kind:"end"})}var r;return e({Kind:"start"}),n(),{Stop:function(){clearTimeout(r)}}}function n(e,t){e({Kind:"start"}),e({Kind:"stderr",Body:t}),e({Kind:"end"})}var r=0;return{Run:function(o,i,s){var a,l=++r;return $.ajax("/compile",{type:"POST",data:{version:2,body:o},dataType:"json",success:function(s){r==l&&s&&(null!=a&&a.Stop(),s.Errors?n(i,s.Errors):e?$.ajax("/vet",{data:{body:o},type:"POST",dataType:"json",success:function(e){e.Errors&&(s.Events||(s.Events=[]),s.Events.unshift({Message:"Go vet exited.\n\n",Kind:"system",Delay:0}),s.Events.unshift({Message:e.Errors,Kind:"stderr",Delay:0})),a=t(i,s.Events)},error:function(){a=t(i,s.Events)}}):a=t(i,s.Events))},error:function(){n(i,"Error communicating with remote server.")}}),{Kill:function(){null!=a&&a.Stop(),i({Kind:"end",Body:"killed"})}}}}}function SocketTransport(){"use strict";function e(e){t.send(JSON.stringify(e))}var t,n=0,r={},o={};return"http:"==window.location.protocol?t=new WebSocket("ws://"+window.location.host+"/socket"):"https:"==window.location.protocol&&(t=new WebSocket("wss://"+window.location.host+"/socket")),t.onclose=function(){console.log("websocket connection closed")},t.onmessage=function(e){var t=JSON.parse(e.data),n=r[t.Id];null!==n&&(o[t.Id]||(n({Kind:"start"}),o[t.Id]=!0),n({Kind:t.Kind,Body:t.Body}))},{Run:function(t,o,i){var s=n+"";return n++,r[s]=o,e({Id:s,Kind:"run",Body:t,Options:i}),{Kill:function(){e({Id:s,Kind:"kill"})}}}}}function PlaygroundOutput(e){"use strict";return function(t){if("start"!=t.Kind){var n="system";"stdout"!=t.Kind&&"stderr"!=t.Kind||(n=t.Kind);var r=t.Body;if("end"==t.Kind&&(r="\nProgram exited"+(r?": "+r:".")),0===r.indexOf("IMAGE:")){var o="data:image/png;base64,"+r.substr(6),i=document.createElement("img");return i.src=o,void e.appendChild(i)}var s=r.split("\f");s.length>1&&(e.innerHTML="",r=s.pop()),r=(r=(r=r.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;");var a=e.scrollTop+e.offsetHeight==e.scrollHeight,l=document.createElement("span");l.className=n,l.innerHTML=r,e.appendChild(l),a&&(e.scrollTop=e.scrollHeight-e.offsetHeight)}else e.innerHTML=""}}!function(){function e(e){for(var t=/prog.go:([0-9]+)/g,n=t.exec(e);n;)$(".lines div").eq(n[1]-1).addClass("lineerror"),n=t.exec(e)}function t(){$(".lineerror").removeClass("lineerror")}function n(n){function r(e){for(var t=p[0].selectionStart,n=p[0].selectionEnd,r=p[0].value,o=r.substr(0,t),i=0;i<e;i++)o+="\t";o+=r.substr(n),p[0].value=o,p[0].selectionStart=t+e,p[0].selectionEnd=t+e}function o(e){if(!n.enableShortcuts||!function(e){return!(e.isDefaultPrevented()||!e.metaKey&&!e.ctrlKey||"S"!=e.key&&"s"!=e.key||(e.preventDefault(),u(function(e){window.location.href=e+".go?download=true"}),0))}(e)){if(9==e.keyCode&&!e.ctrlKey)return r(1),e.preventDefault(),!1;if(13==e.keyCode){if(e.shiftKey)return c(),e.preventDefault(),!1;e.ctrlKey?(d(),e.preventDefault()):function(e){for(var t=e.selectionStart,n=0;t>0;)if(t--,"\t"==e.value[t])n++;else if(n>0||"\n"==e.value[t])break;setTimeout(function(){r(n)},1)}(e.target)}return!0}}function i(){return $(n.codeEl).val()}function s(e){var t=$("#pre");t.text(e),Prism.highlightElement(t[0]),$(n.codeEl).val(e)}function a(n){f&&f.Kill(),t(),e(n),h.empty().addClass("error").text(n)}function l(){t(),f&&f.Kill(),h.removeClass("error").text("Waiting for remote server...")}function c(){l(),f=v.Run(i(),function(t){return function(n){n.Body&&e(n.Body),t(n)}}(PlaygroundOutput(h[0])))}function d(){l();var e={body:i()};$(n.fmtImportEl).is(":checked")&&(e.imports="true"),$.ajax("/fmt",{data:e,type:"POST",dataType:"json",success:function(e){e.Error?a(e.Error):(s(e.Body),a(""))}})}function u(e){if(e&&K.push(e),!m){m=!0;var t=i();$.ajax("/share",{processData:!1,data:t,type:"POST",contentType:"text/plain; charset=utf-8",complete:function(e){if(m=!1,200==e.status){n.shareRedirect&&(window.location=n.shareRedirect+e.responseText);for(var r="/p/"+e.responseText,o=function(e){return(""+e).split("/").slice(0,3).join("/")}(window.location)+r,i=0;i<K.length;i++)K[i](o);if(K=[],g&&(g.show().val(o).focus().select(),E)){var s={code:t};window.history.pushState(s,"",r),w=!1}}else alert("Server error; try again.")}})}}var f,p=$(n.codeEl),v=n.transport||new HTTPTransport(n.enableVet);p.unbind("keydown").bind("keydown",o);var y=$(n.outputEl).empty(),h=$("<pre/>").appendTo(y),w="/"==window.location.pathname,E=!1;window.history&&window.history.pushState&&window.addEventListener&&n.enableHistory&&(E=!0,p[0].addEventListener("input",function(){w||(w=!0,$(n.shareURLEl).hide(),window.history.pushState(null,"","/"))}),window.addEventListener("popstate",function(e){null!==e&&e&&e.state&&e.state.code&&s(e.state.code)}));var g,m=!1,K=[];$(n.runEl).click(c),$(n.fmtEl).click(d),null===n.shareEl||null===n.shareURLEl&&null===n.shareRedirect||(n.shareURLEl&&(g=$(n.shareURLEl).hide()),$(n.shareEl).click(function(){u()})),null!==n.toysEl&&$(n.toysEl).bind("change",function(){var e=$(this).val();$.ajax("/doc/play/"+e,{processData:!1,type:"GET",complete:function(e){200==e.status?s(e.responseText):alert("Server error; try again.")}})})}window.playground=n}();